<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 600px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .test-area {
            border: 2px dashed #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .status {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ PayPulse íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-area">
        <h3>ğŸ“ íŒŒì¼ ì„ íƒ í…ŒìŠ¤íŠ¸</h3>
        <input type="file" id="testFile" accept=".json,.txt,.csv" />
        <div class="status" id="status">ëŒ€ê¸° ì¤‘...</div>
        <div class="status" id="fileInfo"></div>
    </div>

    <div class="test-area">
        <h3>ğŸ“¤ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ (JSONë§Œ)</h3>
        <button onclick="testUpload()" id="uploadBtn" disabled>ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        <div class="status" id="uploadStatus">íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</div>
    </div>

    <script>
        let selectedFile = null;
        
        document.getElementById('testFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const statusDiv = document.getElementById('status');
            const fileInfoDiv = document.getElementById('fileInfo');
            const uploadBtn = document.getElementById('uploadBtn');
            
            console.log('ğŸ“ íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸:', file);
            
            if (!file) {
                statusDiv.textContent = 'âŒ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ';
                uploadBtn.disabled = true;
                return;
            }
            
            selectedFile = file;
            statusDiv.textContent = 'âœ… íŒŒì¼ ì„ íƒë¨';
            fileInfoDiv.innerHTML = `
                <strong>íŒŒì¼ ì •ë³´:</strong><br>
                ì´ë¦„: ${file.name}<br>
                í¬ê¸°: ${file.size} bytes<br>
                íƒ€ì…: ${file.type}<br>
                ìˆ˜ì •ì¼: ${new Date(file.lastModified).toLocaleString()}
            `;
            
            // JSON íŒŒì¼ì¸ ê²½ìš° ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
            if (file.name.toLowerCase().endsWith('.json')) {
                uploadBtn.disabled = false;
            } else {
                uploadBtn.disabled = true;
                document.getElementById('uploadStatus').textContent = 'JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥';
            }
            
            // íŒŒì¼ ì½ê¸° í…ŒìŠ¤íŠ¸
            const reader = new FileReader();
            reader.onload = function(event) {
                console.log('ğŸ“– íŒŒì¼ ì½ê¸° ì™„ë£Œ');
                try {
                    if (file.name.toLowerCase().endsWith('.json')) {
                        const data = JSON.parse(event.target.result);
                        console.log('âœ… JSON íŒŒì‹± ì„±ê³µ:', data.length, 'ê°œ ë ˆì½”ë“œ');
                        statusDiv.textContent = `âœ… JSON íŒŒì‹± ì„±ê³µ: ${data.length}ê°œ ë ˆì½”ë“œ`;
                    } else {
                        console.log('ğŸ“„ í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ì™„ë£Œ');
                        statusDiv.textContent = 'âœ… í…ìŠ¤íŠ¸ íŒŒì¼ ì½ê¸° ì™„ë£Œ';
                    }
                } catch (error) {
                    console.error('âŒ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', error);
                    statusDiv.textContent = 'âŒ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + error.message;
                }
            };
            reader.readAsText(file);
        });
        
        async function testUpload() {
            if (!selectedFile) {
                alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = 'ğŸ“¤ ì—…ë¡œë“œ ì¤‘...';
            
            try {
                // íŒŒì¼ ë‚´ìš© ì½ê¸°
                const fileText = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(selectedFile);
                });
                
                const data = JSON.parse(fileText);
                console.log('ğŸ“Š ì—…ë¡œë“œí•  ë°ì´í„°:', data);
                
                // API í˜¸ì¶œ
                const response = await fetch('/api/payroll/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('ğŸŒ ì„œë²„ ì‘ë‹µ:', result);
                
                if (result.success) {
                    statusDiv.textContent = `âœ… ì—…ë¡œë“œ ì„±ê³µ! íŒŒì¼ëª…: ${result.fileName}`;
                } else {
                    statusDiv.textContent = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error}`;
                }
                
            } catch (error) {
                console.error('âŒ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                statusDiv.textContent = `âŒ ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`;
            }
        }
        
        // ì½˜ì†” ë¡œê·¸ë¥¼ í™”ë©´ì—ë„ í‘œì‹œ
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
        };
        
        console.log('ğŸš€ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>
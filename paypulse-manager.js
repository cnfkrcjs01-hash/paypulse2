// PayPulse Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨Ïûê
class PayPulseDataManager {
    constructor() {
        this.uploadedFiles = [];
        this.currentView = 'dashboard';
        this.selectedFile = null;
    }

    init() {
        this.setupEventListeners();
        this.loadSavedData();
        this.updateUI();
    }

    setupEventListeners() {
        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const view = e.target.getAttribute('data-view');
                this.switchView(view);
            });
        });

        // ÏóÖÎ°úÎìú Í¥ÄÎ†® Î≤ÑÌäºÎì§
        const quickUploadBtn = document.getElementById('quickUploadBtn');
        if (quickUploadBtn) {
            quickUploadBtn.addEventListener('click', () => {
                this.switchView('upload');
            });
        }

        const selectFileBtn = document.getElementById('selectFileBtn');
        if (selectFileBtn) {
            selectFileBtn.addEventListener('click', () => {
                this.selectFile();
            });
        }

        const emptyUploadBtn = document.getElementById('emptyUploadBtn');
        if (emptyUploadBtn) {
            emptyUploadBtn.addEventListener('click', () => {
                this.switchView('upload');
            });
        }

        const analysisBtn = document.getElementById('analysisBtn');
        if (analysisBtn) {
            analysisBtn.addEventListener('click', () => {
                this.switchView('history');
            });
        }

        // ÌååÏùº ÏûÖÎ†•
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    this.handleFileUpload(e.target.files[0]);
                }
            });
        }

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
        const uploadZone = document.getElementById('uploadZone');
        if (uploadZone) {
            uploadZone.addEventListener('click', () => {
                this.selectFile();
            });

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                const excelFile = files.find(f => 
                    f.name.endsWith('.xlsx') || f.name.endsWith('.xls') || f.name.endsWith('.csv')
                );
                
                if (excelFile) {
                    this.handleFileUpload(excelFile);
                }
            });
        }

        // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïï°ÏÖò Î≤ÑÌäºÎì§
        const deleteCurrentBtn = document.getElementById('deleteCurrentBtn');
        if (deleteCurrentBtn) {
            deleteCurrentBtn.addEventListener('click', () => {
                this.deleteCurrentFile();
            });
        }

        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                this.exportToPayPulse();
            });
        }
    }

    // Î∑∞ Ï†ÑÌôò
    switchView(viewName) {
        // Î™®Îì† Î∑∞ Ïà®Í∏∞Í∏∞
        document.querySelectorAll('.view-container').forEach(view => {
            view.style.display = 'none';
        });

        // Î™®Îì† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // ÏÑ†ÌÉùÎêú Î∑∞ ÌëúÏãú
        const targetView = document.getElementById(viewName + 'View');
        if (targetView) {
            targetView.style.display = 'block';
        }

        // ÏÑ†ÌÉùÎêú Î≤ÑÌäº ÌôúÏÑ±Ìôî
        const targetBtn = document.querySelector(`[data-view="${viewName}"]`);
        if (targetBtn) {
            targetBtn.classList.add('active');
        }

        this.currentView = viewName;
    }

    // ÌååÏùº ÏÑ†ÌÉù
    selectFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.click();
        }
    }

    // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
    async handleFileUpload(file) {
        const indicator = document.getElementById('uploadingIndicator');
        const content = document.querySelector('.upload-content');
        
        // ÏóÖÎ°úÎìú ÌëúÏãú
        if (indicator) indicator.style.display = 'block';
        if (content) content.style.display = 'none';

        try {
            // XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨ ÌôïÏù∏
            if (typeof XLSX === 'undefined') {
                throw new Error('XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
            }

            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            
            const sheets = {};
            const allData = [];
            
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                sheets[sheetName] = jsonData;
                allData.push(...jsonData);
            });

            // ÌååÏùº ÌÉÄÏûÖ ÏûêÎèô Í∞êÏßÄ
            let fileType = 'other';
            if (file.name.includes('ÌÖúÌîåÎ¶ø') || file.name.includes('template')) {
                fileType = 'template';
            } else if (file.name.includes('Í∏âÏó¨') || file.name.includes('payroll') || file.name.includes('ÎçîÎØ∏')) {
                fileType = 'payroll';
            }

            const uploadedFile = {
                id: Date.now().toString(),
                name: file.name,
                size: file.size,
                uploadDate: new Date(),
                data: allData,
                sheets: sheets,
                type: fileType
            };

            this.uploadedFiles.push(uploadedFile);
            this.selectedFile = uploadedFile;
            
            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
            this.saveData();
            this.updateUI();
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞Î°ú ÏûêÎèô Ïù¥Îèô
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) previewBtn.style.display = 'inline-block';
            this.switchView('preview');
            this.showPreview(uploadedFile);

            this.showNotification('ÌååÏùºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§! üéâ', 'success');

        } catch (error) {
            console.error('File upload error:', error);
            this.showNotification('ÌååÏùº ÏóÖÎ°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
        } finally {
            // ÏóÖÎ°úÎìú ÌëúÏãú Ïà®Í∏∞Í∏∞
            if (indicator) indicator.style.display = 'none';
            if (content) content.style.display = 'block';
        }
    }

    // UI ÏóÖÎç∞Ïù¥Ìä∏
    updateUI() {
        // Ìó§Îçî
        const fileCountHeader = document.getElementById('fileCountHeader');
        if (fileCountHeader) {
            fileCountHeader.textContent = this.uploadedFiles.length + 'Í∞ú';
        }
        
        const lastUploadDate = this.uploadedFiles.length > 0 ? 
            this.uploadedFiles[this.uploadedFiles.length - 1].uploadDate.toLocaleDateString() : '-';
        const lastUploadDateEl = document.getElementById('lastUploadDate');
        if (lastUploadDateEl) {
            lastUploadDateEl.textContent = lastUploadDate;
        }

        // ÎåÄÏãúÎ≥¥Îìú
        const fileCount = document.getElementById('fileCount');
        if (fileCount) {
            fileCount.textContent = this.uploadedFiles.length + 'Í∞ú';
        }

        const templateCount = document.getElementById('templateCount');
        if (templateCount) {
            templateCount.textContent = this.uploadedFiles.filter(f => f.type === 'template').length;
        }

        const payrollCount = document.getElementById('payrollCount');
        if (payrollCount) {
            payrollCount.textContent = this.uploadedFiles.filter(f => f.type === 'payroll').length;
        }

        this.updateRecentFiles();
        this.updateHistory();
    }

    // ÏµúÍ∑º ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
    updateRecentFiles() {
        const recentFiles = document.getElementById('recentFiles');
        const recentFilesList = document.getElementById('recentFilesList');

        if (!recentFiles || !recentFilesList) return;

        if (this.uploadedFiles.length === 0) {
            recentFiles.style.display = 'none';
            return;
        }

        recentFiles.style.display = 'block';
        recentFilesList.innerHTML = '';

        this.uploadedFiles.slice(-3).forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'recent-file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <span class="file-name">${file.name}</span>
                    <span class="file-date">${file.uploadDate.toLocaleDateString()}</span>
                </div>
                <button class="view-btn">Î≥¥Í∏∞</button>
            `;
            
            fileItem.querySelector('.view-btn').addEventListener('click', () => {
                this.viewFile(file.id);
            });
            
            recentFilesList.appendChild(fileItem);
        });
    }

    // ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
    updateHistory() {
        const emptyState = document.getElementById('emptyState');
        const filesList = document.getElementById('filesList');

        if (!emptyState || !filesList) return;

        if (this.uploadedFiles.length === 0) {
            emptyState.style.display = 'block';
            filesList.style.display = 'none';
            return;
        }

        emptyState.style.display = 'none';
        filesList.style.display = 'block';
        filesList.innerHTML = '';

        this.uploadedFiles.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const typeText = file.type === 'template' ? 'ÌÖúÌîåÎ¶ø' : 
                           file.type === 'payroll' ? 'Í∏âÏó¨ÎåÄÏû•' : 'Í∏∞ÌÉÄ';

            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-header">
                        <span class="file-type-badge ${file.type}">${typeText}</span>
                        <h4>${file.name}</h4>
                    </div>
                    <div class="file-details">
                        <span>ÌÅ¨Í∏∞: ${(file.size / 1024).toFixed(1)} KB</span>
                        <span>ÏóÖÎ°úÎìú: ${file.uploadDate.toLocaleString()}</span>
                        <span>ÏãúÌä∏: ${Object.keys(file.sheets).length}Í∞ú</span>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="view-btn">ÎØ∏Î¶¨Î≥¥Í∏∞</button>
                    <button class="delete-btn">ÏÇ≠Ï†ú</button>
                </div>
            `;
            
            fileItem.querySelector('.view-btn').addEventListener('click', () => {
                this.viewFile(file.id);
            });
            
            fileItem.querySelector('.delete-btn').addEventListener('click', () => {
                this.confirmDelete(file.id);
            });
            
            filesList.appendChild(fileItem);
        });
    }

    // ÌååÏùº Î≥¥Í∏∞
    viewFile(fileId) {
        const file = this.uploadedFiles.find(f => f.id === fileId);
        if (file) {
            this.selectedFile = file;
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) previewBtn.style.display = 'inline-block';
            this.switchView('preview');
            this.showPreview(file);
        }
    }

    // ÎØ∏Î¶¨Î≥¥Í∏∞ ÌëúÏãú
    showPreview(file) {
        const title = document.getElementById('previewTitle');
        const info = document.getElementById('previewInfo');
        const content = document.getElementById('previewContent');

        if (!title || !info || !content) return;

        title.textContent = `üëÅÔ∏è ${file.name}`;
        
        const typeText = file.type === 'template' ? 'ÌÖúÌîåÎ¶ø' : 
                        file.type === 'payroll' ? 'Í∏âÏó¨ÎåÄÏû•' : 'Í∏∞ÌÉÄ';

        info.innerHTML = `
            <span>ÏóÖÎ°úÎìú: ${file.uploadDate.toLocaleString()}</span>
            <span>ÌÅ¨Í∏∞: ${(file.size / 1024).toFixed(1)} KB</span>
            <span class="file-type-badge ${file.type}">${typeText}</span>
        `;

        content.innerHTML = '';

        Object.keys(file.sheets).forEach(sheetName => {
            const sheetDiv = document.createElement('div');
            sheetDiv.className = 'sheet-preview';

            const sheetData = file.sheets[sheetName];
            const maxRows = Math.min(25, sheetData.length); // 25ÌñâÍπåÏßÄ ÌëúÏãú

            let tableHTML = `
                <h3 style="margin: 0; padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #e0e0e0;">üìÑ ${sheetName}</h3>
                <div style="overflow: auto; max-height: 500px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <tbody>
            `;

            for (let i = 0; i < maxRows; i++) {
                const row = sheetData[i] || [];
                const rowClass = i === 0 ? 'style="background: #f8f9fa; font-weight: 600;"' : '';
                tableHTML += `<tr ${rowClass}>`;
                
                const maxCols = Math.min(10, row.length);
                for (let j = 0; j < maxCols; j++) {
                    const cell = row[j] !== null && row[j] !== undefined ? String(row[j]) : '';
                    tableHTML += `<td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0; white-space: nowrap;">${cell}</td>`;
                }
                tableHTML += '</tr>';
            }

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            if (sheetData.length > maxRows) {
                tableHTML += `<p style="padding: 1rem; text-align: center; color: #666; margin: 0;">... Ïô∏ ${sheetData.length - maxRows}Ìñâ Îçî ÏûàÏäµÎãàÎã§ (Ï¥ù ${sheetData.length}Ìñâ)</p>`;
            }

            sheetDiv.innerHTML = tableHTML;
            sheetDiv.style.cssText = 'background: white; margin-bottom: 2rem; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
            content.appendChild(sheetDiv);
        });
    }

    // ÌååÏùº ÏÇ≠Ï†ú ÌôïÏù∏
    confirmDelete(fileId) {
        const file = this.uploadedFiles.find(f => f.id === fileId);
        if (file && confirm(`${file.name}ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            this.deleteFile(fileId);
        }
    }

    // ÌòÑÏû¨ ÌååÏùº ÏÇ≠Ï†ú
    deleteCurrentFile() {
        if (this.selectedFile && confirm(`${this.selectedFile.name}ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
            this.deleteFile(this.selectedFile.id);
        }
    }

    // ÌååÏùº ÏÇ≠Ï†ú
    deleteFile(fileId) {
        this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== fileId);
        
        if (this.selectedFile && this.selectedFile.id === fileId) {
            this.selectedFile = null;
            const previewBtn = document.getElementById('previewBtn');
            if (previewBtn) previewBtn.style.display = 'none';
            this.switchView('dashboard');
        }

        this.saveData();
        this.updateUI();
        this.showNotification('ÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
    }

    // PayPulse Ïó∞Îèô
    exportToPayPulse() {
        if (!this.selectedFile) return;

        const exportData = {
            fileName: this.selectedFile.name,
            type: this.selectedFile.type,
            sheets: this.selectedFile.sheets,
            uploadDate: this.selectedFile.uploadDate
        };

        const paypulseData = JSON.parse(localStorage.getItem('paypulse_integrated_data') || '[]');
        paypulseData.push({
            ...exportData,
            exportDate: new Date(),
            status: 'integrated'
        });
        localStorage.setItem('paypulse_integrated_data', JSON.stringify(paypulseData));

        this.showNotification('Îç∞Ïù¥ÌÑ∞Í∞Ä PayPulse ÏãúÏä§ÌÖúÏóê Ïó∞ÎèôÎêòÏóàÏäµÎãàÎã§! üöÄ', 'success');
    }

    // ÏïåÎ¶º ÌëúÏãú
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    saveData() {
        try {
            localStorage.setItem('paypulse_uploaded_files', JSON.stringify(this.uploadedFiles));
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', error);
        }
    }

    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    loadSavedData() {
        try {
            const savedFiles = localStorage.getItem('paypulse_uploaded_files');

            if (savedFiles) {
                this.uploadedFiles = JSON.parse(savedFiles).map(file => ({
                    ...file,
                    uploadDate: new Date(file.uploadDate)
                }));
            }

            if (this.uploadedFiles.length > 0) {
                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) previewBtn.style.display = 'inline-block';
            }
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
            this.uploadedFiles = [];
        }
    }
}

// Ï†ÑÏó≠ Ìï®ÏàòÎì§ (HTML onclickÏóêÏÑú Ìò∏Ï∂úÏö©)
function showUploadView() {
    if (window.dataManager) {
        window.dataManager.switchView('upload');
    }
}

function selectFile() {
    if (window.dataManager) {
        window.dataManager.selectFile();
    }
}

function deleteCurrentFile() {
    if (window.dataManager) {
        window.dataManager.deleteCurrentFile();
    }
}

function exportToPayPulse() {
    if (window.dataManager) {
        window.dataManager.exportToPayPulse();
    }
}
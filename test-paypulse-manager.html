<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPulse ë°ì´í„° ê´€ë¦¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="PayPulseDataManager.css">
</head>
<body>
    <div id="app">
        <!-- í—¤ë” -->
        <header class="pdm-header">
            <div class="header-content">
                <h1>ğŸ“Š PayPulse ë°ì´í„° ê´€ë¦¬</h1>
                <p>ìŠ¤ë§ˆíŠ¸í•œ ê¸‰ì—¬ ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            </div>
            <!-- í—¤ë” í†µê³„ - ì˜ë¯¸ìˆëŠ” ì •ë³´ë§Œ -->
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">ì—…ë¡œë“œëœ íŒŒì¼</span>
                    <span class="stat-value" id="fileCountHeader">0ê°œ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ìµœê·¼ ì—…ë¡œë“œ</span>
                    <span class="stat-value" id="lastUploadDate">-</span>
                </div>
            </div>
        </header>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="pdm-navigation">
            <button class="nav-btn active" data-view="dashboard">ğŸ  ëŒ€ì‹œë³´ë“œ</button>
            <button class="nav-btn" data-view="upload">ğŸ“¤ ì—…ë¡œë“œ</button>
            <button class="nav-btn" data-view="history">ğŸ“‹ íˆìŠ¤í† ë¦¬</button>
            <button class="nav-btn" data-view="preview" id="previewBtn" style="display: none;">ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</button>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="pdm-content">
            <!-- ëŒ€ì‹œë³´ë“œ ë·° -->
            <div id="dashboardView" class="view-container">
                <!-- ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ - ì˜ë¯¸ì—†ëŠ” ì¹´ë“œ ì œê±° -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼</h3>
                        <div class="file-count" id="fileCount">0ê°œ</div>
                        <div class="file-types">
                            <span>í…œí”Œë¦¿: <span id="templateCount">0</span></span>
                            <span>ê¸‰ì—¬ëŒ€ì¥: <span id="payrollCount">0</span></span>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>ğŸ“Š ë°ì´í„° í˜„í™©</h3>
                        <div class="data-overview">
                            <div>ê°œë³„ íŒŒì¼ë³„ë¡œ</div>
                            <div>ë°ì´í„°ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</div>
                            <div class="data-note">ëˆ„ì  ê³„ì‚°í•˜ì§€ ì•ŠìŒ</div>
                        </div>
                    </div>

                    <div class="dashboard-card quick-upload">
                        <h3>âš¡ ë¹ ë¥¸ ì—…ë¡œë“œ</h3>
                        <button class="quick-upload-btn" onclick="showUploadView()">
                            ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                        </button>
                    </div>

                    <div class="dashboard-card">
                        <h3>ğŸ” ë°ì´í„° ë¶„ì„</h3>
                        <div class="analysis-info">
                            <div>ê° íŒŒì¼ì„ ê°œë³„ì ìœ¼ë¡œ</div>
                            <div>ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í™•ì¸í•˜ì„¸ìš”</div>
                            <button class="analysis-btn" onclick="dataManager.switchView('history')">
                                íŒŒì¼ ëª©ë¡ ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <div class="recent-files" id="recentFiles" style="display: none;">
                    <h3>ìµœê·¼ ì—…ë¡œë“œëœ íŒŒì¼</h3>
                    <div class="recent-files-list" id="recentFilesList"></div>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ë·° -->
            <div id="uploadView" class="view-container" style="display: none;">
                <div class="upload-container">
                    <h2>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</h2>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-content">
                            <div class="upload-icon">ğŸ“</div>
                            <h3>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</h3>
                            <p>Excel (.xlsx, .xls), CSV íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤</p>
                            <button class="upload-btn" onclick="selectFile()">íŒŒì¼ ì„ íƒ</button>
                        </div>
                        <div class="uploading" id="uploadingIndicator" style="display: none;">
                            <div class="spinner"></div>
                            <p>ì—…ë¡œë“œ ì¤‘...</p>
                        </div>
                    </div>

                    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">

                    <div class="upload-guide">
                        <h4>ğŸ“‹ ì—…ë¡œë“œ ê°€ì´ë“œ</h4>
                        <ul>
                            <li>Excel íŒŒì¼(.xlsx, .xls) ë˜ëŠ” CSV íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                            <li>íŒŒì¼ëª…ì— "í…œí”Œë¦¿"ì´ í¬í•¨ë˜ë©´ í…œí”Œë¦¿ìœ¼ë¡œ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤</li>
                            <li>íŒŒì¼ëª…ì— "ê¸‰ì—¬"ê°€ í¬í•¨ë˜ë©´ ê¸‰ì—¬ëŒ€ì¥ìœ¼ë¡œ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤</li>
                            <li>ì—…ë¡œë“œëœ íŒŒì¼ì€ ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- íˆìŠ¤í† ë¦¬ ë·° -->
            <div id="historyView" class="view-container" style="display: none;">
                <h2>ğŸ“‹ ì—…ë¡œë“œ íˆìŠ¤í† ë¦¬</h2>
                
                <div class="empty-state" id="emptyState">
                    <p>ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <button class="upload-btn" onclick="showUploadView()">
                        ì²« ë²ˆì§¸ íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°
                    </button>
                </div>

                <div class="files-list" id="filesList" style="display: none;"></div>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸° ë·° -->
            <div id="previewView" class="view-container" style="display: none;">
                <div class="preview-header">
                    <h2 id="previewTitle">ğŸ‘ï¸ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°</h2>
                    <div class="preview-info" id="previewInfo"></div>
                </div>

                <div class="preview-content" id="previewContent"></div>

                <div class="preview-actions">
                    <button class="delete-btn" onclick="deleteCurrentFile()">
                        ğŸ—‘ï¸ íŒŒì¼ ì‚­ì œ
                    </button>
                    <button class="export-btn" onclick="exportToPayPulse()">
                        ğŸ“Š PayPulse ì—°ë™
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="paypulse-manager.js"></script>
    
    <script>
        // PayPulse ë°ì´í„° ê´€ë¦¬ì
        class PayPulseManager {
            constructor() {
                this.uploadedFiles = [];
                this.currentFile = null;
                this.currentView = 'dashboard';
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateUI();
                this.loadFromStorage();
            }

            setupEventListeners() {
                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.target.dataset.view;
                        if (view) this.switchView(view);
                    });
                });

                // íŒŒì¼ ì…ë ¥
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            this.handleFileUpload(e.target.files[0]);
                        }
                    });
                }

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­
                const uploadZone = document.getElementById('uploadZone');
                if (uploadZone) {
                    uploadZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadZone.classList.add('dragover');
                    });

                    uploadZone.addEventListener('dragleave', () => {
                        uploadZone.classList.remove('dragover');
                    });

                    uploadZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadZone.classList.remove('dragover');
                        const files = Array.from(e.dataTransfer.files);
                        const excelFile = files.find(f => 
                            f.name.endsWith('.xlsx') || f.name.endsWith('.xls') || f.name.endsWith('.csv')
                        );
                        if (excelFile) {
                            this.handleFileUpload(excelFile);
                        }
                    });
                }
            }

            // ğŸ¯ ì™„ì „íˆ ê°œì„ ëœ UI ì—…ë°ì´íŠ¸
            updateUI() {
                // í—¤ë” í†µê³„ - ì˜ë¯¸ì—†ëŠ” ëˆ„ì  ë°ì´í„°ëŠ” '-'ë¡œ í‘œì‹œ
                document.getElementById('totalEmployees').textContent = '-';
                document.getElementById('totalSalary').textContent = '-';

                // ëŒ€ì‹œë³´ë“œ - íŒŒì¼ ì •ë³´ë§Œ ì˜ë¯¸ìˆê²Œ í‘œì‹œ
                document.getElementById('fileCount').textContent = this.uploadedFiles.length + 'ê°œ';
                document.getElementById('templateCount').textContent = this.uploadedFiles.filter(f => f.type === 'template').length;
                document.getElementById('payrollCount').textContent = this.uploadedFiles.filter(f => f.type === 'payroll').length;

                // ì˜ë¯¸ì—†ëŠ” ëˆ„ì  ë°ì´í„°ëŠ” '-'ë¡œ í‘œì‹œ
                document.getElementById('employeeCount').textContent = '-';
                document.getElementById('departmentCount').textContent = '-';
                document.getElementById('totalAmount').textContent = '-';
                document.getElementById('avgAmount').textContent = '-';

                // ìµœê·¼ íŒŒì¼ ëª©ë¡ ì—…ë°ì´íŠ¸
                this.updateRecentFiles();
                this.updateHistoryView();
            }

            updateRecentFiles() {
                const recentFilesContainer = document.getElementById('recentFiles');
                const recentFilesList = document.getElementById('recentFilesList');
                
                if (this.uploadedFiles.length > 0) {
                    recentFilesContainer.style.display = 'block';
                    const recentFiles = this.uploadedFiles.slice(-3);
                    recentFilesList.innerHTML = recentFiles.map(file => `
                        <div class="recent-file-item">
                            <div class="file-info">
                                <span class="file-name">${file.name}</span>
                                <span class="file-date">${file.uploadDate.toLocaleDateString()}</span>
                            </div>
                            <button class="view-btn" onclick="manager.viewFile('${file.id}')">ë³´ê¸°</button>
                        </div>
                    `).join('');
                } else {
                    recentFilesContainer.style.display = 'none';
                }
            }

            updateHistoryView() {
                const emptyState = document.getElementById('emptyState');
                const filesList = document.getElementById('filesList');

                if (this.uploadedFiles.length === 0) {
                    emptyState.style.display = 'block';
                    filesList.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    filesList.style.display = 'block';
                    filesList.innerHTML = this.uploadedFiles.map(file => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-header">
                                    <span class="file-type-badge ${file.type}">
                                        ${file.type === 'template' ? 'í…œí”Œë¦¿' : file.type === 'payroll' ? 'ê¸‰ì—¬ëŒ€ì¥' : 'ê¸°íƒ€'}
                                    </span>
                                    <h4>${file.name}</h4>
                                </div>
                                <div class="file-details">
                                    <span>í¬ê¸°: ${(file.size / 1024).toFixed(1)} KB</span>
                                    <span>ì—…ë¡œë“œ: ${file.uploadDate.toLocaleString()}</span>
                                    <span>ì‹œíŠ¸: ${file.sheets ? Object.keys(file.sheets).length : 1}ê°œ</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="view-btn" onclick="manager.viewFile('${file.id}')">ë¯¸ë¦¬ë³´ê¸°</button>
                                <button class="delete-btn" onclick="manager.deleteFile('${file.id}')">ì‚­ì œ</button>
                            </div>
                        </div>
                    `).join('');
                }
            }

            async handleFileUpload(file) {
                this.showUploading(true);

                try {
                    // íŒŒì¼ íƒ€ì… ê°ì§€
                    let fileType = 'other';
                    if (file.name.includes('í…œí”Œë¦¿') || file.name.includes('template')) {
                        fileType = 'template';
                    } else if (file.name.includes('ê¸‰ì—¬') || file.name.includes('payroll')) {
                        fileType = 'payroll';
                    }

                    // Excel íŒŒì¼ ì½ê¸°
                    const arrayBuffer = await file.arrayBuffer();
                    let sheets = {};
                    
                    if (file.name.endsWith('.csv')) {
                        const text = await file.text();
                        const rows = text.split('\n').map(row => row.split(','));
                        sheets['Sheet1'] = rows;
                    } else {
                        // Excel ì²˜ë¦¬ (SheetJS ì‚¬ìš©)
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        workbook.SheetNames.forEach(sheetName => {
                            const worksheet = workbook.Sheets[sheetName];
                            sheets[sheetName] = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        });
                    }

                    const uploadedFile = {
                        id: Date.now().toString(),
                        name: file.name,
                        size: file.size,
                        uploadDate: new Date(),
                        type: fileType,
                        sheets: sheets
                    };

                    this.uploadedFiles.push(uploadedFile);
                    this.currentFile = uploadedFile;
                    this.saveToStorage();
                    this.updateUI();
                    
                    // ë¯¸ë¦¬ë³´ê¸°ë¡œ ìë™ ì´ë™
                    this.switchView('preview');
                    
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    this.showUploading(false);
                }
            }

            switchView(viewName) {
                // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
                document.querySelectorAll('.view-container').forEach(view => {
                    view.style.display = 'none';
                });

                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // ì„ íƒëœ ë·° ë³´ì´ê¸°
                const targetView = document.getElementById(viewName + 'View');
                if (targetView) {
                    targetView.style.display = 'block';
                }

                // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
                const targetBtn = document.querySelector(`[data-view="${viewName}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }

                this.currentView = viewName;

                // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¸°ê¸°
                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) {
                    previewBtn.style.display = this.currentFile ? 'block' : 'none';
                }

                // ë·°ë³„ ì¶”ê°€ ì²˜ë¦¬
                if (viewName === 'preview' && this.currentFile) {
                    this.showPreview(this.currentFile);
                }
            }

            showPreview(file) {
                document.getElementById('previewTitle').textContent = `ğŸ‘ï¸ ${file.name}`;
                
                const previewInfo = document.getElementById('previewInfo');
                previewInfo.innerHTML = `
                    <span>ì—…ë¡œë“œ: ${file.uploadDate.toLocaleString()}</span>
                    <span>í¬ê¸°: ${(file.size / 1024).toFixed(1)} KB</span>
                    <span class="type-badge ${file.type}">
                        ${file.type === 'template' ? 'í…œí”Œë¦¿' : file.type === 'payroll' ? 'ê¸‰ì—¬ëŒ€ì¥' : 'ê¸°íƒ€'}
                    </span>
                `;

                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = Object.keys(file.sheets).map(sheetName => `
                    <div class="sheet-preview">
                        <h3>ğŸ“„ ${sheetName}</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <tbody>
                                    ${file.sheets[sheetName].slice(0, 10).map((row, rowIndex) => `
                                    <tr class="${rowIndex === 0 ? 'header-row' : ''}">
                                        ${row.map(cell => `<td>${cell || ''}</td>`).join('')}
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${file.sheets[sheetName].length > 10 ? `
                            <p class="more-data">... ì™¸ ${file.sheets[sheetName].length - 10}í–‰ ë” ìˆìŠµë‹ˆë‹¤</p>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            }

            viewFile(fileId) {
                const file = this.uploadedFiles.find(f => f.id === fileId);
                if (file) {
                    this.currentFile = file;
                    this.switchView('preview');
                }
            }

            deleteFile(fileId) {
                const file = this.uploadedFiles.find(f => f.id === fileId);
                if (file && confirm(`${file.name}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.uploadedFiles = this.uploadedFiles.filter(f => f.id !== fileId);
                    if (this.currentFile?.id === fileId) {
                        this.currentFile = null;
                        this.switchView('dashboard');
                    }
                    this.saveToStorage();
                    this.updateUI();
                }
            }

            showUploading(show) {
                const uploadContent = document.querySelector('.upload-content');
                const uploadingIndicator = document.getElementById('uploadingIndicator');
                
                if (uploadContent && uploadingIndicator) {
                    uploadContent.style.display = show ? 'none' : 'block';
                    uploadingIndicator.style.display = show ? 'block' : 'none';
                }
            }

            saveToStorage() {
                try {
                    localStorage.setItem('payPulseFiles', JSON.stringify(this.uploadedFiles.map(file => ({
                        ...file,
                        uploadDate: file.uploadDate.toISOString()
                    }))));
                } catch (error) {
                    console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('payPulseFiles');
                    if (saved) {
                        this.uploadedFiles = JSON.parse(saved).map(file => ({
                            ...file,
                            uploadDate: new Date(file.uploadDate)
                        }));
                        this.updateUI();
                    }
                } catch (error) {
                    console.error('ë¡œë“œ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        function selectFile() {
            document.getElementById('fileInput').click();
        }

        function showUploadView() {
            manager.switchView('upload');
        }

        function deleteCurrentFile() {
            if (manager.currentFile) {
                manager.deleteFile(manager.currentFile.id);
            }
        }

        function exportToPayPulse() {
            alert('PayPulse ì—°ë™ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ë§¤ë‹ˆì € ì´ˆê¸°í™”
        const manager = new PayPulseManager();
        
        console.log('ğŸ¯ PayPulse ë°ì´í„° ê´€ë¦¬ ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPulse - AI ì¸ê±´ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="expert_analysis_styles.css">
    <link rel="stylesheet" href="comprehensive_labor_styles.css">
    <link rel="stylesheet" href="insurance_rates_styles.css">
    <link rel="stylesheet" href="file_management_styles.css">
    <link rel="stylesheet" href="ai_analytics_styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">ğŸ’°</div>
                <span>PayPulse</span>
            </div>

            <div class="menu-section">
                <div class="menu-title">ëŒ€ì‹œë³´ë“œ</div>
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>ë©”ì¸ ëŒ€ì‹œë³´ë“œ</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">ì¸ê±´ë¹„ ê´€ë¦¬</div>
                <div class="menu-item" data-page="comprehensive-labor">
                    <i class="fas fa-chart-line"></i>
                    <span>ì¢…í•© ì¸ê±´ë¹„</span>
                </div>
                <div class="menu-item" data-page="expert-analysis">
                    <i class="fas fa-brain"></i>
                    <span>ì „ë¬¸ê°€ ë¶„ì„&ì˜ˆì¸¡</span>
                </div>
                <div class="menu-item" data-page="direct-labor">
                    <i class="fas fa-hard-hat"></i>
                    <span>ì§ì ‘ ì¸ê±´ë¹„</span>
                </div>
                <div class="menu-item" data-page="indirect-labor">
                    <i class="fas fa-briefcase"></i>
                    <span>ê°„ì ‘ ì¸ê±´ë¹„</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">ë°ì´í„° ê´€ë¦¬</div>
                <div class="menu-item" data-page="upload">
                    <i class="fas fa-upload"></i>
                    <span>í†µí•© ë°ì´í„° ì—…ë¡œë“œ</span>
                </div>
                <div class="menu-item" data-page="upload-history">
                    <i class="fas fa-history"></i>
                    <span>ì—…ë¡œë“œ í™”ë©´</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">ë³´í—˜ ë° ê³„ì‚°</div>
                <div class="menu-item" data-page="insurance">
                    <i class="fas fa-shield-alt"></i>
                    <span>4ëŒ€ ë³´í—˜ ìš”ìœ¨</span>
                </div>
                <div class="menu-item" data-page="calculation">
                    <i class="fas fa-calculator"></i>
                    <span>ìŠ¤ë§ˆíŠ¸ ì¸ê±´ë¹„ ê³„ì‚°ê¸°</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">í‡´ì§ ê´€ë¦¬</div>
                <div class="menu-item" data-page="provision">
                    <i class="fas fa-chart-line"></i>
                    <span>í‡´ì§ì¶©ë‹¹ê¸ˆ</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">AI ë¶„ì„</div>
                <div class="menu-item" data-page="ai-chat">
                    <i class="fas fa-robot"></i>
                    <span>AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                </div>
                <div class="menu-item" data-page="analytics">
                    <i class="fas fa-brain"></i>
                    <span>AI ì§„ë‹¨ ë¶„ì„</span>
                </div>
                <div class="menu-item" data-page="hc-roi">
                    <i class="fas fa-chart-pie"></i>
                    <span>ì „ë¬¸ê°€ ë¶„ì„&ì˜ˆì¸¡</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-title">ë¦¬í¬íŠ¸</div>
                <div class="menu-item" data-page="reports">
                    <i class="fas fa-file-alt"></i>
                    <span>ê¸‰ì—¬ëª…ì„¸ì„œ</span>
                </div>
                <div class="menu-item" data-page="risk-matrix">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤</span>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div class="main-content">
            <div class="header">
                <h1>PayPulse</h1>
                <p>AI ê¸°ë°˜ ìŠ¤ë§ˆíŠ¸ ì¸ê±´ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
                <div class="subtitle">ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ìœ¼ë¡œ ë¯¸ë˜ë¥¼ ì˜ˆì¸¡í•˜ì„¸ìš”</div>
            </div>

            <!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œë“¤ -->
            <div class="dashboard" id="main-dashboard">
                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>ì¢…í•© ì¸ê±´ë¹„</h3>
                    <p>ê¸‰ì—¬/ìƒì—¬ ëŒ€ì¥, ì „ë¬¸ë¶„ì„ ë°ì´í„°, ì§ì› ì •ë³´ë¥¼ í†µí•©í•˜ì—¬ ì¢…í•©ì ì¸ ì¸ê±´ë¹„ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                    <br>
                    <button class="btn" onclick="switchPage('data-center')">
                        <i class="fas fa-arrow-right"></i>
                        ì‹œì‘í•˜ê¸°
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>AI ì–´ì‹œìŠ¤í„´íŠ¸</h3>
                    <p>ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³¼ê±° ë¶„ì„, í˜„ì¬ ì§„ë‹¨, ë¯¸ë˜ ì˜ˆì¸¡ê¹Œì§€ ì œê³µí•˜ëŠ” ë˜‘ë˜‘í•œ AIì…ë‹ˆë‹¤.</p>
                    <br>
                    <button class="btn btn-secondary" onclick="switchPage('ai-chat')">
                        <i class="fas fa-comments"></i>
                        ëŒ€í™” ì‹œì‘
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h3>ìŠ¤ë§ˆíŠ¸ ê³„ì‚°</h3>
                    <p>4ëŒ€ë³´í—˜ ìš”ìœ¨ ìë™ ì ìš©, í‡´ì§ê¸ˆ ê³„ì‚°, ì¸ê±´ë¹„ ì‹œë®¬ë ˆì´ì…˜ê¹Œì§€ í•œ ë²ˆì— ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
                    <br>
                    <button class="btn btn-outline" onclick="switchPage('calculation')">
                        <i class="fas fa-play"></i>
                        ê³„ì‚°í•˜ê¸°
                    </button>
                </div>

                <div class="card">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>ë¶„ì„ & ì˜ˆì¸¡</h3>
                    <p>HC ROI ë¶„ì„, ë¦¬ìŠ¤í¬ ë§¤íŠ¸ë¦­ìŠ¤, íŠ¸ë Œë“œ ì˜ˆì¸¡ìœ¼ë¡œ ì „ëµì  ì¸ì‚¬ê´€ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</p>
                    <br>
                    <button class="btn btn-outline" onclick="switchPage('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        ë¶„ì„ ë³´ê¸°
                    </button>
                </div>
            </div>

            <!-- ê° í˜ì´ì§€ ì½˜í…ì¸ ëŠ” ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            <div id="page-content"></div>
        </div>
    </div>

    <!-- Chart.js for dashboard visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="chart_utils.js"></script>
    <script src="script.js"></script>
    <script src="expert_analysis.js"></script>
    <script src="comprehensive_labor.js"></script>
    <script src="insurance_rates.js"></script>
    <script src="salary_calculator.js"></script>
    <script src="ai_analytics.js"></script>
    
    <!-- í‘œì¤€ JavaScript íŒŒì¼ ì—…ë¡œë“œ ì‹œìŠ¤í…œ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… PayPulse ë©”ì¸ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
            
            // ê¸°ì¡´ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œë„
            if (typeof initializeUnifiedUpload === 'function') {
                try {
                    initializeUnifiedUpload();
                    console.log('âœ… í†µí•© ì—…ë¡œë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
                } catch (error) {
                    console.log('âš ï¸ í†µí•© ì—…ë¡œë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error.message);
                }
            }
            
            // í‘œì¤€ ë°©ì‹ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ìˆ˜ì • (ì§€ì—° ì‹¤í–‰)
            setTimeout(() => {
                initializeStandardFileUpload();
            }, 1000);
        });
        
        // í‘œì¤€ JavaScriptë¡œ íŒŒì¼ ì—…ë¡œë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeStandardFileUpload() {
            console.log('ğŸ”§ í‘œì¤€ ë°©ì‹ìœ¼ë¡œ ë²„íŠ¼ ìˆ˜ì • ì‹œì‘...');

            // ëª¨ë“  ë²„íŠ¼ì„ í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸°
            const buttons = Array.from(document.querySelectorAll('button'));
            const fileButtons = buttons.filter(btn => 
                btn.textContent.includes('íŒŒì¼ ì„ íƒ') || 
                btn.textContent.includes('íŒŒì¼') ||
                btn.getAttribute('data-action') === 'select-file' ||
                btn.classList.contains('upload-btn')
            );

            console.log('ë°œê²¬ëœ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼:', fileButtons.length, 'ê°œ');

            fileButtons.forEach((btn, index) => {
                console.log(`ë²„íŠ¼ ${index + 1}:`, btn.textContent.trim());
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ëª¨ë‘ ì œê±°
                const newBtn = btn.cloneNode(true);
                
                // ìƒˆë¡œìš´ í´ë¦­ ì´ë²¤íŠ¸
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ğŸ”¥ íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­ë¨!');
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json,.txt';
                    input.style.display = 'none';
                    
                    input.addEventListener('change', function(event) {
                        const file = event.target.files[0];
                        if (!file) return;
                        
                        // íŒŒì¼ í˜•ì‹ ê²€ì¦
                        const allowedTypes = ['application/json', 'text/plain', 'text/json'];
                        const allowedExtensions = ['.json', '.txt'];
                        const isValidType = allowedTypes.includes(file.type) || 
                                          allowedExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
                        
                        if (!isValidType) {
                            alert('âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n\nJSON íŒŒì¼(.json) ë˜ëŠ” í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                            return;
                        }
                        
                        // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB)
                        if (file.size > 10 * 1024 * 1024) {
                            alert('âŒ íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.\n\nìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                            return;
                        }
                        
                        console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', file.name, `(${Math.round(file.size/1024)}KB)`);
                        
                        const reader = new FileReader();
                        reader.addEventListener('load', function(e) {
                            try {
                                let content = e.target.result;
                                // ğŸ”§ ì´ˆê°•ë ¥ JSON ì •ë¦¬ ì‹œìŠ¤í…œ (ì²« ë²ˆì§¸ ë°©ì‹)
                                console.log('ğŸ”§ ì²« ë²ˆì§¸ ë°©ì‹: ê¸°ë³¸ ì •ë¦¬');
                                content = content.replace(/^\uFEFF/, ''); // BOM ì œê±°
                                content = content.replace(/:\s*NaN/g, ': null');
                                content = content.replace(/:\s*undefined/g, ': null');
                                content = content.replace(/:\s*Infinity/g, ': null');
                                content = content.replace(/:\s*-Infinity/g, ': null');
                                content = content.replace(/,(\s*[}\]])/g, '$1'); // ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
                                content = content.replace(/'/g, '"'); // ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ
                                
                                // ì¶”ê°€ êµ¬ë¬¸ ì •ë¦¬
                                content = content.replace(/}(\s*)"/g, '},$1"'); // } ë‹¤ìŒì— ë°”ë¡œ " ì˜¤ëŠ” ê²½ìš°
                                content = content.replace(/}(\s*){/g, '},$1{'); // } ë‹¤ìŒì— ë°”ë¡œ { ì˜¤ëŠ” ê²½ìš°
                                
                                console.log('ğŸ“‹ ì²« ë²ˆì§¸ ë°©ì‹ ì •ë¦¬ ì™„ë£Œ:', content.substring(0, 200) + '...');
                                
                                // ì•ˆì „ íŒŒì‹±
                                let data;
                                try {
                                    data = JSON.parse(content);
                                    console.log('âœ… ì²« ë²ˆì§¸ ë°©ì‹ íŒŒì‹± ì„±ê³µ!');
                                } catch (error) {
                                    console.log('âŒ ì²« ë²ˆì§¸ ë°©ì‹ íŒŒì‹± ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘...');
                                    // ë” ê³µê²©ì ì¸ ì •ë¦¬
                                    const cleanContent = content.replace(/\s+/g, ' ').replace(/,(\s*[}\]])/g, '$1');
                                    data = JSON.parse(cleanContent);
                                    console.log('âœ… ì²« ë²ˆì§¸ ë°©ì‹ ì¬ì‹œë„ ì„±ê³µ!');
                                }
                                
                                // ë°ì´í„° ê²€ì¦
                                if (!Array.isArray(data)) {
                                    throw new Error('JSON ë°ì´í„°ëŠ” ë°°ì—´ í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.');
                                }
                                
                                if (data.length === 0) {
                                    throw new Error('ì—…ë¡œë“œëœ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                                }
                                
                                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                                window.payrollData = data;
                                window.payrollFileInfo = {
                                    name: file.name,
                                    size: file.size,
                                    recordCount: data.length,
                                    uploadDate: new Date()
                                };
                                
                                console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ:', data.length, 'ê°œ');
                                
                                const message = `âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ!\n\nğŸ“Š ì´ ${data.length}ê°œì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“ íŒŒì¼ëª…: ${file.name}\nğŸ’¾ íŒŒì¼ í¬ê¸°: ${Math.round(file.size/1024)}KB`;
                                alert(message);
                                
                                // ì—…ë¡œë“œ ì„±ê³µ ì´ë²¤íŠ¸ ë°œìƒ
                                window.dispatchEvent(new CustomEvent('payrollDataLoaded', {
                                    detail: {
                                        data: data,
                                        recordCount: data.length,
                                        fileName: file.name,
                                        success: true
                                    }
                                }));
                                
                            } catch (error) {
                                console.error('âŒ ì˜¤ë¥˜:', error);
                                
                                let errorMessage = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                
                                if (error instanceof SyntaxError) {
                                    // JSON êµ¬ë¬¸ ì˜¤ë¥˜ì— ëŒ€í•œ ìƒì„¸í•œ ë„ì›€ë§
                                    errorMessage = `JSON í˜•ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ğŸ”§ í•´ê²° ë°©ë²•:
1. íŒŒì¼ì´ ì˜¬ë°”ë¥¸ JSON ë°°ì—´ í˜•íƒœì¸ì§€ í™•ì¸í•˜ì„¸ìš”
   ì˜ˆ: [{"ì´ë¦„": "í™ê¸¸ë™", "ê¸‰ì—¬": 3000000}, ...]

2. ë‹¤ìŒ ë¬¸ì œë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”:
   - ë§ˆì§€ë§‰ í•­ëª© ë’¤ì— ì‰¼í‘œ(,)ê°€ ìˆëŠ”ì§€
   - ë”°ì˜´í‘œê°€ ì˜¬ë°”ë¥´ê²Œ ë‹«í˜”ëŠ”ì§€
   - ì¤‘ê´„í˜¸ {}ì™€ ëŒ€ê´„í˜¸ []ê°€ ì˜¬ë°”ë¥´ê²Œ ë§¤ì¹­ë˜ëŠ”ì§€

3. ì˜¨ë¼ì¸ JSON ê²€ì¦ê¸°ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”
   (jsonlint.com ë“±)

ìƒì„¸ ì˜¤ë¥˜: ${error.message}`;
                                } else {
                                    errorMessage = error.message;
                                }
                                
                                alert('âŒ íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + errorMessage);
                            }
                        });
                        
                        reader.addEventListener('error', function() {
                            console.error('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                            alert('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                        });
                        
                        reader.readAsText(file, 'utf-8');
                    });
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                });
                
                // ë²„íŠ¼ êµì²´
                btn.parentNode.replaceChild(newBtn, btn);
                console.log('âœ… ë²„íŠ¼ êµì²´ ì™„ë£Œ:', newBtn.textContent.trim());
            });

            console.log('ğŸ‰ ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ìˆ˜ì • ì™„ë£Œ!');
            
            // data-action ì†ì„±ì´ ìˆëŠ” ë²„íŠ¼ë“¤ë„ ì²˜ë¦¬
            console.log('ğŸ”§ data-action ë²„íŠ¼ë“¤ ì²˜ë¦¬ ì¤‘...');

            const dataActionButtons = document.querySelectorAll('[data-action*="file"], [data-action*="upload"], [data-action*="select"]');

            dataActionButtons.forEach(btn => {
                console.log('data-action ë²„íŠ¼ ë°œê²¬:', btn.getAttribute('data-action'));
                
                // ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€
                if (!btn.hasAttribute('data-action-processed')) {
                    btn.setAttribute('data-action-processed', 'true');
                    
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ğŸ”¥ data-action ë²„íŠ¼ í´ë¦­ë¨!');
                        
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json,.txt';
                        input.style.display = 'none';
                        
                        input.onchange = function(evt) {
                            const file = evt.target.files[0];
                            if (!file) return;
                            
                            console.log('ğŸ“ data-action íŒŒì¼ ì„ íƒë¨:', file.name);
                            
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                try {
                                    let content = event.target.result;
                                    // NaN ê°’ ë° BOM ì²˜ë¦¬
                                    // ğŸ”§ ì´ˆê°•ë ¥ JSON ì •ë¦¬ ì‹œìŠ¤í…œ
                                    console.log('ğŸ”§ 1ë‹¨ê³„: ê¸°ë³¸ ì •ë¦¬ ì‹œì‘');
                                    content = content.replace(/^\uFEFF/, ''); // BOM ì œê±°
                                    content = content.replace(/:\s*NaN/g, ': null');
                                    content = content.replace(/:\s*undefined/g, ': null');
                                    content = content.replace(/:\s*Infinity/g, ': null');
                                    content = content.replace(/:\s*-Infinity/g, ': null');
                                    
                                    console.log('ğŸ”§ 2ë‹¨ê³„: ê³ ê¸‰ êµ¬ë¬¸ ì •ë¦¬');
                                    // ì˜ëª»ëœ ì‰¼í‘œ íŒ¨í„´ ìˆ˜ì •
                                    content = content.replace(/,(\s*[}\]])/g, '$1'); // ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
                                    content = content.replace(/([}\]])\s*,\s*([}\]])/g, '$1$2'); // ì—°ì† ì‰¼í‘œ ì œê±°
                                    content = content.replace(/,\s*,/g, ','); // ì¤‘ë³µ ì‰¼í‘œ ì œê±°
                                    
                                    console.log('ğŸ”§ 3ë‹¨ê³„: ë”°ì˜´í‘œ ë° ê´„í˜¸ ì •ë¦¬');
                                    content = content.replace(/'/g, '"'); // ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ
                                    content = content.replace(/([^\\])"/g, '$1"'); // ì´ìŠ¤ì¼€ì´í”„ë˜ì§€ ì•Šì€ ë”°ì˜´í‘œ ì •ë¦¬
                                    
                                    console.log('ğŸ”§ 4ë‹¨ê³„: ëˆ„ë½ëœ êµ¬ë¶„ì ì¶”ê°€');
                                    // ê°ì²´/ë°°ì—´ êµ¬ë¶„ì ë¬¸ì œ í•´ê²°
                                    content = content.replace(/}(\s*)"/g, '},$1"'); // } ë‹¤ìŒì— ë°”ë¡œ " ì˜¤ëŠ” ê²½ìš°
                                    content = content.replace(/}(\s*){/g, '},$1{'); // } ë‹¤ìŒì— ë°”ë¡œ { ì˜¤ëŠ” ê²½ìš°
                                    content = content.replace(/](\s*)"/g, '],$1"'); // ] ë‹¤ìŒì— ë°”ë¡œ " ì˜¤ëŠ” ê²½ìš°
                                    content = content.replace(/](\s*)\[/g, '],$1['); // ] ë‹¤ìŒì— ë°”ë¡œ [ ì˜¤ëŠ” ê²½ìš°
                                    
                                    console.log('ğŸ”§ 5ë‹¨ê³„: ìµœì¢… ì •ë¦¬');
                                    content = content.replace(/,(\s*[}\]])/g, '$1'); // ë‹¤ì‹œ í•œë²ˆ ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
                                    
                                    console.log('ğŸ“‹ ì •ë¦¬ëœ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:', content.substring(0, 300) + '...');
                                    
                                    // ğŸ¯ ë‹¨ê³„ë³„ ì•ˆì „ íŒŒì‹± ì‹œë„
                                    let data;
                                    let parseAttempt = 1;
                                    
                                    console.log('ğŸ¯ íŒŒì‹± ì‹œë„ 1: ê¸°ë³¸ JSON.parse');
                                    try {
                                        data = JSON.parse(content);
                                        console.log('âœ… ê¸°ë³¸ íŒŒì‹± ì„±ê³µ!');
                                    } catch (firstError) {
                                        console.log('âŒ ê¸°ë³¸ íŒŒì‹± ì‹¤íŒ¨:', firstError.message);
                                        
                                        console.log('ğŸ¯ íŒŒì‹± ì‹œë„ 2: ì¶”ê°€ ì •ë¦¬ í›„ ì¬ì‹œë„');
                                        try {
                                            // ë” ê³µê²©ì ì¸ ì •ë¦¬
                                            let cleanContent = content
                                                .replace(/,(\s*[}\]])/g, '$1') // ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
                                                .replace(/([^\\])\\(?!["\\/bfnrt])/g, '$1') // ì˜ëª»ëœ ì´ìŠ¤ì¼€ì´í”„ ì œê±°
                                                .replace(/\n/g, ' ') // ì¤„ë°”ê¿ˆì„ ê³µë°±ìœ¼ë¡œ
                                                .replace(/\r/g, '') // ìºë¦¬ì§€ ë¦¬í„´ ì œê±°
                                                .replace(/\t/g, ' ') // íƒ­ì„ ê³µë°±ìœ¼ë¡œ
                                                .replace(/\s+/g, ' '); // ì—°ì† ê³µë°±ì„ í•˜ë‚˜ë¡œ
                                            
                                            data = JSON.parse(cleanContent);
                                            console.log('âœ… ì¶”ê°€ ì •ë¦¬ í›„ íŒŒì‹± ì„±ê³µ!');
                                        } catch (secondError) {
                                            console.log('âŒ ì¶”ê°€ ì •ë¦¬ í›„ì—ë„ ì‹¤íŒ¨:', secondError.message);
                                            
                                            console.log('ğŸ¯ íŒŒì‹± ì‹œë„ 3: ì˜¤ë¥˜ ìœ„ì¹˜ ê¸°ë°˜ ìˆ˜ì •');
                                            try {
                                                // ì˜¤ë¥˜ ìœ„ì¹˜ ì •ë³´ ì¶”ì¶œ
                                                const errorMatch = secondError.message.match(/position (\d+)/);
                                                if (errorMatch) {
                                                    const errorPos = parseInt(errorMatch[1]);
                                                    console.log('ğŸ” ì˜¤ë¥˜ ìœ„ì¹˜:', errorPos);
                                                    
                                                    // ì˜¤ë¥˜ ìœ„ì¹˜ ì£¼ë³€ ë‚´ìš© í™•ì¸
                                                    const beforeError = content.substring(Math.max(0, errorPos - 50), errorPos);
                                                    const afterError = content.substring(errorPos, Math.min(content.length, errorPos + 50));
                                                    console.log('ğŸ” ì˜¤ë¥˜ ì£¼ë³€:', beforeError + '[HERE]' + afterError);
                                                    
                                                    // ê°„ë‹¨í•œ ìˆ˜ì • ì‹œë„
                                                    let fixedContent = content.substring(0, errorPos) + ',' + content.substring(errorPos);
                                                    data = JSON.parse(fixedContent);
                                                    console.log('âœ… ì˜¤ë¥˜ ìœ„ì¹˜ ìˆ˜ì • í›„ íŒŒì‹± ì„±ê³µ!');
                                                } else {
                                                    throw secondError;
                                                }
                                            } catch (thirdError) {
                                                console.log('âŒ ëª¨ë“  íŒŒì‹± ì‹œë„ ì‹¤íŒ¨');
                                                throw new Error(`JSON íŒŒì‹± ì‹¤íŒ¨ (3íšŒ ì‹œë„)\n\nì›ë³¸ ì˜¤ë¥˜: ${firstError.message}\n\ní•´ê²° ë°©ë²•:\n1. ì˜¨ë¼ì¸ JSON ê²€ì¦ê¸°(jsonlint.com)ì—ì„œ íŒŒì¼ ê²€ì‚¬\n2. ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ í›„ í˜•ì‹ ì°¸ê³ \n3. í…ìŠ¤íŠ¸ ì—ë””í„°ì—ì„œ êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì •`);
                                            }
                                        }
                                    }
                                    
                                    // ë°ì´í„° ê²€ì¦
                                    if (!Array.isArray(data)) {
                                        throw new Error('JSON ë°ì´í„°ëŠ” ë°°ì—´ í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.');
                                    }
                                    
                                    if (data.length === 0) {
                                        throw new Error('ì—…ë¡œë“œëœ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                                    }
                                    
                                    // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                                    window.payrollData = data;
                                    window.payrollFileInfo = {
                                        name: file.name,
                                        size: file.size,
                                        recordCount: data.length,
                                        uploadDate: new Date()
                                    };
                                    
                                    console.log('âœ… data-action ì—…ë¡œë“œ ì„±ê³µ:', data.length, 'ê°œ');
                                    
                                    const message = `âœ… data-action ì—…ë¡œë“œ ì„±ê³µ!\n\nğŸ“Š ì´ ${data.length}ê°œì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“ íŒŒì¼ëª…: ${file.name}\nğŸ’¾ íŒŒì¼ í¬ê¸°: ${Math.round(file.size/1024)}KB`;
                                    alert(message);
                                    
                                    // ì—…ë¡œë“œ ì„±ê³µ ì´ë²¤íŠ¸ ë°œìƒ
                                    window.dispatchEvent(new CustomEvent('payrollDataLoaded', {
                                        detail: {
                                            data: data,
                                            recordCount: data.length,
                                            fileName: file.name,
                                            success: true
                                        }
                                    }));
                                    
                                } catch (error) {
                                    console.error('âŒ data-action ì˜¤ë¥˜:', error);
                                    alert('âŒ ì˜¤ë¥˜: ' + error.message);
                                }
                            };
                            
                            reader.onerror = function() {
                                console.error('âŒ data-action íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                                alert('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                            };
                            
                            reader.readAsText(file, 'utf-8');
                        };
                        
                        document.body.appendChild(input);
                        input.click();
                        document.body.removeChild(input);
                    });
                }
            });

            console.log('âœ… data-action ë²„íŠ¼ë“¤ ì²˜ë¦¬ ì™„ë£Œ!');
            
            // ì „ì²´ í˜ì´ì§€ì— ì´ë²¤íŠ¸ ìœ„ì„ (ìµœì¢… ë³´í—˜ì±…)
            console.log('ğŸ”§ ì „ì²´ í˜ì´ì§€ ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • ì¤‘...');
            
            document.addEventListener('click', function(e) {
                const target = e.target;
                const text = target.textContent || '';
                
                // íŒŒì¼ ê´€ë ¨ í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ìš”ì†Œ í´ë¦­ ì‹œ
                if ((text.includes('íŒŒì¼ ì„ íƒ') || text.includes('íŒŒì¼') || text.includes('ì—…ë¡œë“œ')) && 
                    !target.hasAttribute('data-delegation-processed')) {
                    
                    // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
                    target.setAttribute('data-delegation-processed', 'true');
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ğŸ”¥ í˜ì´ì§€ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ íŒŒì¼ ì—…ë¡œë“œ ì‹¤í–‰!', text.trim());
                    
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json,.txt';
                    input.style.display = 'none';
                    
                    input.onchange = function(evt) {
                        const file = evt.target.files[0];
                        if (!file) return;
                        
                        console.log('ğŸ“ ì´ë²¤íŠ¸ ìœ„ì„ íŒŒì¼ ì„ íƒë¨:', file.name);
                        
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            try {
                                let content = event.target.result;
                                // ê°•ë ¥í•œ JSON ì •ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹)
                                content = content.replace(/^\uFEFF/, ''); // BOM ì œê±°
                                content = content.replace(/:\s*NaN/g, ': null');
                                content = content.replace(/:\s*undefined/g, ': null');
                                content = content.replace(/:\s*Infinity/g, ': null');
                                content = content.replace(/:\s*-Infinity/g, ': null');
                                content = content.replace(/,(\s*[}\]])/g, '$1'); // ë§ˆì§€ë§‰ ì‰¼í‘œ ì œê±°
                                content = content.replace(/'/g, '"'); // ì‘ì€ë”°ì˜´í‘œë¥¼ í°ë”°ì˜´í‘œë¡œ
                                
                                console.log('ğŸ“‹ ì´ë²¤íŠ¸ ìœ„ì„ íŒŒì¼ ë‚´ìš©:', content.substring(0, 200) + '...');
                                
                                const data = JSON.parse(content);
                                
                                // ë°ì´í„° ê²€ì¦
                                if (!Array.isArray(data)) {
                                    throw new Error('JSON ë°ì´í„°ëŠ” ë°°ì—´ í˜•íƒœì—¬ì•¼ í•©ë‹ˆë‹¤.');
                                }
                                
                                if (data.length === 0) {
                                    throw new Error('ì—…ë¡œë“œëœ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                                }
                                
                                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                                window.payrollData = data;
                                window.payrollFileInfo = {
                                    name: file.name,
                                    size: file.size,
                                    recordCount: data.length,
                                    uploadDate: new Date()
                                };
                                
                                console.log('âœ… ì´ë²¤íŠ¸ ìœ„ì„ ì—…ë¡œë“œ ì„±ê³µ:', data.length, 'ê°œ');
                                
                                const message = `âœ… ì´ë²¤íŠ¸ ìœ„ì„ ì—…ë¡œë“œ ì„±ê³µ!\n\nğŸ“Š ì´ ${data.length}ê°œì˜ ê¸‰ì—¬ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\nğŸ“ íŒŒì¼ëª…: ${file.name}\nğŸ’¾ íŒŒì¼ í¬ê¸°: ${Math.round(file.size/1024)}KB`;
                                alert(message);
                                
                                // ì—…ë¡œë“œ ì„±ê³µ ì´ë²¤íŠ¸ ë°œìƒ
                                window.dispatchEvent(new CustomEvent('payrollDataLoaded', {
                                    detail: {
                                        data: data,
                                        recordCount: data.length,
                                        fileName: file.name,
                                        success: true
                                    }
                                }));
                                
                            } catch (error) {
                                console.error('âŒ ì´ë²¤íŠ¸ ìœ„ì„ ì˜¤ë¥˜:', error);
                                
                                let errorMessage = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                if (error instanceof SyntaxError) {
                                    errorMessage = 'JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                                } else {
                                    errorMessage = error.message;
                                }
                                
                                alert('âŒ ì˜¤ë¥˜: ' + errorMessage);
                            }
                        };
                        
                        reader.onerror = function() {
                            console.error('âŒ ì´ë²¤íŠ¸ ìœ„ì„ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                            alert('âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨');
                        };
                        
                        reader.readAsText(file, 'utf-8');
                    };
                    
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                    
                    return false;
                }
            });

            console.log('âœ… ì „ì²´ í˜ì´ì§€ ì´ë²¤íŠ¸ ìœ„ì„ ì„¤ì • ì™„ë£Œ!');
            console.log('ğŸ¯ ì´ì œ íŒŒì¼ ì„ íƒ ë²„íŠ¼ì„ í´ë¦­í•´ë³´ì„¸ìš”!');
            
            // íŒŒì¼ ì§€ì†ì„± ë° ê´€ë¦¬ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initializeFileManagement();
        }
        
        // íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeFileManagement() {
            console.log('ğŸ—‚ï¸ íŒŒì¼ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ë¡œë“œ
            loadUploadedFilesList();
            
            // í˜„ì¬ í™œì„± ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (window.payrollData && window.payrollData.length > 0) {
                displayCurrentData();
            }
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ ì‹œ ëª©ë¡ì— ì¶”ê°€
        function addToUploadedFilesList(fileInfo, data) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            
            const newFile = {
                id: Date.now().toString(),
                name: fileInfo.name,
                size: fileInfo.size,
                recordCount: Array.isArray(data) ? data.length : 1,
                uploadDate: new Date().toISOString(),
                data: data // ì‹¤ì œ ë°ì´í„°ë„ ì €ì¥
            };
            
            // ì¤‘ë³µ íŒŒì¼ëª… ì²´í¬ í›„ ì¶”ê°€
            const existingIndex = uploadedFiles.findIndex(f => f.name === newFile.name);
            if (existingIndex >= 0) {
                uploadedFiles[existingIndex] = newFile; // ë®ì–´ì“°ê¸°
            } else {
                uploadedFiles.unshift(newFile); // ë§¨ ì•ì— ì¶”ê°€
            }
            
            // ìµœëŒ€ 10ê°œ íŒŒì¼ë§Œ ìœ ì§€
            if (uploadedFiles.length > 10) {
                uploadedFiles.splice(10);
            }
            
            localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
            loadUploadedFilesList();
            displayCurrentData();
            
            console.log('ğŸ“ íŒŒì¼ì´ ëª©ë¡ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:', newFile.name);
        }
        
        // ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ë¡œë“œ ë° í‘œì‹œ
        function loadUploadedFilesList() {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const noFilesMessage = document.getElementById('noFilesMessage');
            const filesList = document.getElementById('filesList');
            
            if (uploadedFiles.length === 0) {
                if (noFilesMessage) noFilesMessage.style.display = 'block';
                if (filesList) filesList.style.display = 'none';
                return;
            }
            
            if (noFilesMessage) noFilesMessage.style.display = 'none';
            if (filesList) {
                filesList.style.display = 'block';
                filesList.innerHTML = uploadedFiles.map(file => `
                    <div class="file-item" data-file-id="${file.id}">
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="file-details">
                                <h4 class="file-name">${file.name}</h4>
                                <div class="file-meta">
                                    <span class="file-size">${Math.round(file.size/1024)}KB</span>
                                    <span class="file-records">${file.recordCount.toLocaleString()}ê°œ ë ˆì½”ë“œ</span>
                                    <span class="file-date">${new Date(file.uploadDate).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small" onclick="loadFileData('${file.id}')" title="ë°ì´í„° ë¡œë“œ">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="downloadFile('${file.id}')" title="ë‹¤ìš´ë¡œë“œ">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteFile('${file.id}')" title="ì‚­ì œ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // í˜„ì¬ í™œì„± ë°ì´í„° í‘œì‹œ
        function displayCurrentData() {
            const currentDataSection = document.getElementById('currentDataSection');
            if (!window.payrollData || !window.payrollFileInfo) {
                if (currentDataSection) currentDataSection.style.display = 'none';
                return;
            }
            
            if (currentDataSection) {
                currentDataSection.style.display = 'block';
                
                // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
                const elements = {
                    currentFileName: window.payrollFileInfo.name,
                    currentUploadTime: new Date(window.payrollFileInfo.uploadDate || Date.now()).toLocaleString(),
                    currentTotalRecords: window.payrollData.length.toLocaleString(),
                    currentTotalColumns: Object.keys(window.payrollData[0] || {}).length
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
                
                // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
                createDataPreviewTable();
            }
        }
        
        // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
        function createDataPreviewTable() {
            const tableHead = document.getElementById('currentDataTableHead');
            const tableBody = document.getElementById('currentDataTableBody');
            
            if (!tableHead || !tableBody || !window.payrollData) return;
            
            const data = window.payrollData;
            const columns = Object.keys(data[0] || {});
            const previewData = data.slice(0, 10); // ì²˜ìŒ 10ê°œë§Œ
            
            // í…Œì´ë¸” í—¤ë” ìƒì„±
            tableHead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;
            
            // í…Œì´ë¸” ë°”ë”” ìƒì„±
            tableBody.innerHTML = previewData.map(row => 
                `<tr>${columns.map(col => `<td>${row[col] || '-'}</td>`).join('')}</tr>`
            ).join('');
        }
        
        // íŒŒì¼ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        window.refreshFileList = function() {
            loadUploadedFilesList();
            console.log('ğŸ”„ íŒŒì¼ ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        window.loadFileData = function(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (file && file.data) {
                window.payrollData = file.data;
                window.payrollFileInfo = {
                    name: file.name,
                    size: file.size,
                    recordCount: file.recordCount,
                    uploadDate: file.uploadDate
                };
                
                displayCurrentData();
                alert(`âœ… "${file.name}" ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n${file.recordCount}ê°œ ë ˆì½”ë“œ`);
                console.log('ğŸ“‚ íŒŒì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', file.name);
            }
        };
        
        window.downloadFile = function(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (file && file.data) {
                const blob = new Blob([JSON.stringify(file.data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('ğŸ’¾ íŒŒì¼ ë‹¤ìš´ë¡œë“œ:', file.name);
            }
        };
        
        window.deleteFile = function(fileId) {
            const uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
            const file = uploadedFiles.find(f => f.id === fileId);
            
            if (file && confirm(`"${file.name}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const filteredFiles = uploadedFiles.filter(f => f.id !== fileId);
                localStorage.setItem('uploadedFiles', JSON.stringify(filteredFiles));
                loadUploadedFilesList();
                
                // í˜„ì¬ í™œì„± ë°ì´í„°ê°€ ì‚­ì œëœ íŒŒì¼ì´ë©´ ì´ˆê¸°í™”
                if (window.payrollFileInfo && window.payrollFileInfo.name === file.name) {
                    window.payrollData = null;
                    window.payrollFileInfo = null;
                    displayCurrentData();
                }
                
                alert(`"${file.name}" íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                console.log('ğŸ—‘ï¸ íŒŒì¼ ì‚­ì œ:', file.name);
            }
        };
        
        window.viewDataDetails = function() {
            if (!window.payrollData) {
                alert('í™œì„± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = window.payrollData;
            const info = window.payrollFileInfo;
            
            const details = `
ğŸ“Š ë°ì´í„° ìƒì„¸ ì •ë³´

ğŸ“ íŒŒì¼ëª…: ${info.name}
ğŸ“… ì—…ë¡œë“œ ì‹œê°„: ${new Date(info.uploadDate || Date.now()).toLocaleString()}
ğŸ“ˆ ì´ ë ˆì½”ë“œ ìˆ˜: ${data.length.toLocaleString()}ê°œ
ğŸ“‹ ì»¬ëŸ¼ ìˆ˜: ${Object.keys(data[0] || {}).length}ê°œ
ğŸ’¾ íŒŒì¼ í¬ê¸°: ${Math.round(info.size/1024)}KB

ğŸ·ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ:
${Object.keys(data[0] || {}).slice(0, 10).join(', ')}${Object.keys(data[0] || {}).length > 10 ? '...' : ''}

ğŸ“Š ìƒ˜í”Œ ë°ì´í„°:
${JSON.stringify(data[0], null, 2)}
            `;
            
            alert(details);
        };
        
        window.downloadCurrentData = function() {
            if (!window.payrollData || !window.payrollFileInfo) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const blob = new Blob([JSON.stringify(window.payrollData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.payrollFileInfo.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ’¾ í˜„ì¬ ë°ì´í„° ë‹¤ìš´ë¡œë“œ:', window.payrollFileInfo.name);
        };
        
        // ì—…ë¡œë“œ ì„±ê³µ ì‹œ ë°ì´í„° í‘œì‹œ
        function showUploadSuccess(data, fileName) {
            console.log('âœ… ì—…ë¡œë“œ ì„±ê³µ í™”ë©´ í‘œì‹œ:', fileName);
            
            // ì—…ë¡œë“œ ì„±ê³µ ì„¹ì…˜ í‘œì‹œ
            const successSection = document.getElementById('uploadSuccessSection');
            if (successSection) {
                successSection.style.display = 'block';
                
                // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
                const elements = {
                    successFileName: fileName,
                    successRecordCount: data.length.toLocaleString() + 'ê°œ',
                    successUploadTime: new Date().toLocaleString(),
                    successFieldCount: Object.keys(data[0] || {}).length + 'ê°œ'
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value;
                });
                
                // ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
                createSuccessPreviewTable(data);
                
                // í•„ë“œ ì •ë³´ ìƒì„±
                createFieldsInfo(data[0] || {});
            }
        }
        
        // ì„±ê³µ ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ìƒì„±
        function createSuccessPreviewTable(data, showAllFields = false) {
            const tableHead = document.getElementById('successTableHead');
            const tableBody = document.getElementById('successTableBody');
            
            if (!tableHead || !tableBody || !data.length) return;
            
            const allFields = Object.keys(data[0]);
            const displayFields = showAllFields ? allFields : allFields.slice(0, 5);
            const previewData = data.slice(0, 5); // ì²˜ìŒ 5ê°œ ë ˆì½”ë“œë§Œ
            
            // í…Œì´ë¸” í—¤ë”
            tableHead.innerHTML = `<tr>${displayFields.map(field => `<th>${field}</th>`).join('')}</tr>`;
            
            // í…Œì´ë¸” ë°”ë””
            tableBody.innerHTML = previewData.map(row => 
                `<tr>${displayFields.map(field => `<td>${row[field] || '-'}</td>`).join('')}</tr>`
            ).join('');
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const showAllBtn = document.getElementById('showAllFieldsBtn');
            const showLessBtn = document.getElementById('showLessFieldsBtn');
            
            if (showAllFields) {
                if (showAllBtn) showAllBtn.style.display = 'none';
                if (showLessBtn) showLessBtn.style.display = 'inline-block';
            } else {
                if (showAllBtn) showAllBtn.style.display = allFields.length > 5 ? 'inline-block' : 'none';
                if (showLessBtn) showLessBtn.style.display = 'none';
            }
        }
        
        // í•„ë“œ ì •ë³´ ìƒì„±
        function createFieldsInfo(firstRecord) {
            const fieldsList = document.getElementById('successFieldsList');
            if (!fieldsList) return;
            
            const fields = Object.keys(firstRecord);
            fieldsList.innerHTML = fields.map(field => {
                const value = firstRecord[field];
                const type = typeof value;
                return `
                    <div class="field-item">
                        <span class="field-name">${field}</span>
                        <span class="field-type">${type}</span>
                        <span class="field-sample">${value}</span>
                    </div>
                `;
            }).join('');
        }
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ í•¨ìˆ˜ë“¤
        window.showAllFields = function() {
            if (window.payrollData) {
                createSuccessPreviewTable(window.payrollData, true);
            }
        };
        
        window.showLessFields = function() {
            if (window.payrollData) {
                createSuccessPreviewTable(window.payrollData, false);
            }
        };
        
        window.clearUploadedData = function() {
            if (confirm('ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.payrollData = null;
                window.payrollFileInfo = null;
                
                const successSection = document.getElementById('uploadSuccessSection');
                if (successSection) successSection.style.display = 'none';
                
                console.log('ğŸ—‘ï¸ ì—…ë¡œë“œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ');
            }
        };
        
        window.downloadUploadedData = function() {
            if (!window.payrollData || !window.payrollFileInfo) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const blob = new Blob([JSON.stringify(window.payrollData, null, 2)], { 
                type: 'application/json;charset=utf-8' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.payrollFileInfo.name || 'payroll_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ’¾ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
        };
        
        // ì—…ë¡œë“œ ì„±ê³µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
        document.addEventListener('payrollDataLoaded', function(event) {
            const { data, fileName, recordCount } = event.detail;
            
            // ì—…ë¡œë“œ ì„±ê³µ í™”ë©´ í‘œì‹œ
            showUploadSuccess(data, fileName);
        });
        
        // ìƒ˜í”Œ JSON ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ ê°œì„ 
        window.downloadSampleJSON = function() {
            const sampleData = [
                {
                    "ê¸‰ì—¬ì¼_ê¸‰ì—¬ìœ í˜•": "2024.01.25 ê¸‰ì—¬_ì •ê¸°ê¸‰ì—¬",
                    "ê¸‰ì—¬ì˜ì—­": "(ì£¼)ìƒ˜í”ŒíšŒì‚¬",
                    "ì‚¬ë²ˆ": "E2024001",
                    "ì„±ëª…": "í™ê¸¸ë™",
                    "ì…ì‚¬ì¼": 20240101,
                    "ê·¸ë£¹ì…ì‚¬ì¼": 20240101,
                    "ì„±ë³„": "ë‚¨",
                    "ì¡°ì§": "ì¸ì‚¬íŒ€",
                    "ì§ì±…": "íŒ€ì›",
                    "ì§ê¸‰": "ëŒ€ë¦¬",
                    "í˜¸ë´‰": "3ê¸‰",
                    "ê¸°ë³¸ê¸‰": 3000000,
                    "ì§ì±…ê¸‰": 200000,
                    "ì‹ëŒ€": 100000,
                    "êµí†µë¹„": 150000,
                    "ì‹¤ì§€ê¸‰ì•¡": 2800000,
                    "ì—°ë„": 2024
                },
                {
                    "ê¸‰ì—¬ì¼_ê¸‰ì—¬ìœ í˜•": "2024.01.25 ê¸‰ì—¬_ì •ê¸°ê¸‰ì—¬",
                    "ê¸‰ì—¬ì˜ì—­": "(ì£¼)ìƒ˜í”ŒíšŒì‚¬",
                    "ì‚¬ë²ˆ": "E2024002",
                    "ì„±ëª…": "ê¹€ì˜í¬",
                    "ì…ì‚¬ì¼": 20230315,
                    "ê·¸ë£¹ì…ì‚¬ì¼": 20230315,
                    "ì„±ë³„": "ì—¬",
                    "ì¡°ì§": "ê°œë°œíŒ€",
                    "ì§ì±…": "ì„ ì„",
                    "ì§ê¸‰": "ê³¼ì¥",
                    "í˜¸ë´‰": "5ê¸‰",
                    "ê¸°ë³¸ê¸‰": 4200000,
                    "ì§ì±…ê¸‰": 300000,
                    "ì‹ëŒ€": 100000,
                    "êµí†µë¹„": 150000,
                    "ì‹¤ì§€ê¸‰ì•¡": 3850000,
                    "ì—°ë„": 2024
                },
                {
                    "ê¸‰ì—¬ì¼_ê¸‰ì—¬ìœ í˜•": "2024.01.25 ê¸‰ì—¬_ì •ê¸°ê¸‰ì—¬",
                    "ê¸‰ì—¬ì˜ì—­": "(ì£¼)ìƒ˜í”ŒíšŒì‚¬",
                    "ì‚¬ë²ˆ": "E2024003",
                    "ì„±ëª…": "ë°•ì² ìˆ˜",
                    "ì…ì‚¬ì¼": 20220701,
                    "ê·¸ë£¹ì…ì‚¬ì¼": 20220701,
                    "ì„±ë³„": "ë‚¨",
                    "ì¡°ì§": "ì˜ì—…íŒ€",
                    "ì§ì±…": "íŒ€ì¥",
                    "ì§ê¸‰": "ì°¨ì¥",
                    "í˜¸ë´‰": "7ê¸‰",
                    "ê¸°ë³¸ê¸‰": 5500000,
                    "ì§ì±…ê¸‰": 500000,
                    "ì‹ëŒ€": 100000,
                    "êµí†µë¹„": 150000,
                    "ì‹¤ì§€ê¸‰ì•¡": 5200000,
                    "ì—°ë„": 2024
                }
            ];
            
            const blob = new Blob([JSON.stringify(sampleData, null, 2)], { 
                type: 'application/json;charset=utf-8' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'payroll_sample.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“„ ìƒ˜í”Œ JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
            alert('ğŸ“„ ìƒ˜í”Œ JSON íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ë°ì´í„° í˜•ì‹ì„ ë§ì¶°ì£¼ì„¸ìš”.');
        };
    </script>

</body>
</html>
